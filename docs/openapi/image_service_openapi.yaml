openapi: 3.0.3
info:
  title: Image Service (LocalStack)
  version: "1.0.0"
  description: |
    Local Image Service API (Upload, List, Delete).
    - Upload returns presigned PUT URL.
    - List returns metadata and presigned GET URL for UPLOADED items.
servers:
  - url: "http://localhost:4566/restapis/{api_id}/local/_user_request_"
    variables:
      api_id:
        default: "REPLACE_WITH_API_ID"
        description: "API Gateway ID provided by deploy_localstack.sh"
paths:
  /uploadImages:
    post:
      summary: Request a presigned PUT URL and create metadata entry (PENDING_UPLOAD)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UploadRequest'
      responses:
        '200':
          description: Presigned upload URL and metadata
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UploadResponse'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /listImages:
    get:
      summary: List images for a user (filters + pagination). Presigned GET returned only for UPLOADED items.
      parameters:
        - in: query
          name: user_id
          schema:
            type: string
          required: true
        - in: query
          name: filename
          schema:
            type: string
          required: false
          description: Substring match on filename
        - in: query
          name: content_type
          schema:
            type: string
          required: false
          description: Exact content-type match (e.g. image/png)
        - in: query
          name: page_token
          schema:
            type: string
          required: false
          description: Token for pagination
      responses:
        '200':
          description: Paginated list of images
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ListResponse'
        '400':
          description: Missing user_id
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
  /deleteImages:
    delete:
      summary: Delete an image (remove DDB item; remove S3 object only when status == UPLOADED)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DeleteRequest'
      responses:
        '200':
          description: Delete result
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DeleteResponse'
        '404':
          description: Not found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
components:
  schemas:
    UploadRequest:
      type: object
      required: [user_id, filename, content_type]
      properties:
        user_id:
          type: string
        filename:
          type: string
        content_type:
          type: string
    UploadResponse:
      type: object
      properties:
        upload_url:
          type: string
          description: Presigned PUT URL for direct upload to S3
        image_id:
          type: string
        s3_key:
          type: string
        expires_in:
          type: integer
    ImageItem:
      type: object
      properties:
        image_id:
          type: string
        filename:
          type: string
        content_type:
          type: string
        created_at:
          type: integer
        status:
          type: string
          enum: [PENDING_UPLOAD, UPLOADED]
        # only present when status == UPLOADED
        bucket:
          type: string
        s3_key:
          type: string
        signed_url:
          type: string
          description: Presigned GET URL (only for UPLOADED items)
    ListResponse:
      type: object
      properties:
        items:
          type: array
          items:
            $ref: '#/components/schemas/ImageItem'
        count:
          type: integer
        expires_in:
          type: integer
        next_page_token:
          type: string
    DeleteRequest:
      type: object
      required: [user_id, image_id]
      properties:
        user_id:
          type: string
        image_id:
          type: string
    DeleteResponse:
      type: object
      properties:
        image_id:
          type: string
        user_id:
          type: string
        s3_key:
          type: string
        s3_deleted:
          type: boolean
        ddb_deleted:
          type: boolean
    Error:
      type: object
      properties:
        error:
          type: string